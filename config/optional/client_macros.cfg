###########################################################################
# 可选的 Happy Hare 支持客户端宏
#
# 这些是推荐用于Happy Hare的PAUSE/RESUME/CANCEL_PRINT宏命令，
# 它们使用在'mmu_sequence.cfg'中定义的停车逻辑
# 并在'mmu_macro_vars.cfg'中集中配置。
#
#（您也可以使用现有的套件。例如来自 Mainsail）
#
#
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
description: Pause the print and park
gcode:
    {% set vars = printer['gcode_macro _MMU_CLIENT_VARS'] %}

    {% if printer.pause_resume.is_paused %}
        RESPOND MSG="Print is already paused"
    {% else %}
        _RETRACT
        _MMU_SAVE_POSITION
        BASE_PAUSE
        _MMU_PARK
        {vars.user_pause_extension|default("")}
    {% endif %}

[gcode_macro RESUME]
rename_existing: BASE_RESUME
description: Resume the print
gcode:
    {% set vars = printer['gcode_macro _MMU_CLIENT_VARS'] %}

    {% if not printer.pause_resume.is_paused %}
        RESPOND MSG="Print is not paused. Resume ignored"
    {% else %}
        _MMU_RESTORE_POSITION
        {vars.user_resume_extension|default("")}
        _UNRETRACT
        BASE_RESUME
    {% endif %}

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
description: Cancel print
gcode:
    {% set vars = printer['gcode_macro _MMU_CLIENT_VARS'] %}

    RESPOND MSG="Print cancelled!"
    _MMU_PARK Z_HOP=10
    _MMU_CLEAR_POSITION
    TURN_OFF_HEATERS
    M107 ; 风扇关闭
    {vars.user_cancel_extension|default("")}
    BASE_CANCEL_PRINT

[gcode_macro _RETRACT]
description: Helper to retract filament in pause and cancel
gcode:
    {% set vars = printer['gcode_macro _MMU_CLIENT_VARS'] %}
    {% set length = params.LENGTH|default(vars.retract)|default(1.0)|float %}
    {% set speed = params.SPEED|default(vars.retract_speed)|default(20)|int %}

    _UNRETRACT LENGTH=-{length|abs} SPEED={speed}

[gcode_macro _UNRETRACT]
description: Helper to extruder filament in resume to undo retract
gcode:
    {% set vars = printer['gcode_macro _MMU_CLIENT_VARS'] %}
    {% set length = params.LENGTH|default(vars.retract)|default(1.0)|float %}
    {% set speed = params.SPEED|default(vars.unretract_speed)|default(20)|int %}

    # 如果Happy Hare没有管理它，则仅应用回缩
    {% if not printer.mmu.enabled or not printer.mmu.is_paused %}
        SAVE_GCODE_STATE NAME=MMU_RETRACT_state

        {% if printer.extruder.can_extrude %}
            M83 ; 挤出机相对模式
            G1 E{length} F{speed|abs * 60}
        {% endif %}

        RESTORE_GCODE_STATE NAME=MMU_RETRACT_state
    {% endif %}

